<!doctype html>
<html>

<head>
<title>Is Eddie Here?</title>
<style>

html {
  height: 100%;
  overflow: hidden;
  position: relative;
  width: 100%;
}

body {
  text-align: center;
}

h1 {
  font-family: sans-serif;
  font-size: 160px;
  font-weight: bold;
  line-height: 1;
  position: absolute;
  text-align: center;
  top: 50%;
  width: 100%;
}

</style>
</head>

<body>
<label><input type="checkbox" id="notify"> Tell me when Eddie gets back</label>
<h1 id="status"></h1>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script>

function status() {
  return document.getElementById('status');
}

function notifyCheckbox() {
  return document.getElementById('notify');
}

function notify() {
  if (!document.hidden)
    return;

  if (!window.Notification) // feature detect for Notifications
    return;

  if (window.notification)  // only show 1 notification at a time
    return;

  if (!notifyCheckbox().checked)
    return;

  if (status().textContent.trim().toLowerCase() != 'yes')
    return;

  notification = new Notification("Is Eddie here?", {
    body: 'YES, Eddie is back.',
    icon: 'icon.png'
  });

  setTimeout(hideNotification, 5000);
}

function hideNotification() {
  if (window.notification) {
    notification.close();
    notification = null;
  }
}

io.connect().on('change', function(data) {
  if (data == status().textContent.trim())
    return;

  status().textContent = data;
  sync();

  setTimeout(notify, 10000);
});

function sync() {
  status().style.marginTop = -status().offsetHeight / 2 + 'px';
}

window.onresize = sync;

window.onload = function() {
  notifyCheckbox().checked = /notify=true/.test(document.cookie);
  notifyCheckbox().onchange = function(e) {
    if (notifyCheckbox().checked)
      Notification.requestPermission();
    document.cookie = 'notify=' + notifyCheckbox().checked;
  };
};

window.onbeforeunload = window.onunload = hideNotification;

</script>
</body>

</html>
